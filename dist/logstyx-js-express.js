var M=Object.defineProperty,W=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var S=Object.getOwnPropertySymbols;var J=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var C=(e,t,s)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,i=(e,t)=>{for(var s in t||(t={}))J.call(t,s)&&C(e,s,t[s]);if(S)for(var s of S(t))K.call(t,s)&&C(e,s,t[s]);return e},m=(e,t)=>W(e,G(t));var h=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var O=h(T=>{T.safeParse=e=>{try{return e?JSON.parse(e):{}}catch(t){return{}}};T.num2Int=e=>isNaN(e)?0:parseInt(e)});var P=h(b=>{var{num2Int:B}=O(),V=require("crypto");b.generateSignature=(e,t,s={})=>{let o=new Date().getTime(),n=JSON.stringify(s),a=e+n+B(o),l=V.createHmac("SHA256",t).update(a).digest("hex").toUpperCase();return{timestamp:o,signature:l}}});var I=h((ve,H)=>{var Q=Object.defineProperty,E=Object.getOwnPropertySymbols,X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable,k=(e,t,s)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,A=(e,t)=>{for(var s in t||(t={}))X.call(t,s)&&k(e,s,t[s]);if(E)for(var s of E(t))Y.call(t,s)&&k(e,s,t[s]);return e},j=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Z=(e,t,s)=>new Promise((o,n)=>{var a=c=>{try{r(s.next(c))}catch(d){n(d)}},l=c=>{try{r(s.throw(c))}catch(d){n(d)}},r=c=>c.done?o(c.value):Promise.resolve(c.value).then(a,l);r((s=s.apply(e,t)).next())}),q=j(e=>{e.sanitizeObject=t=>Object.entries(t).reduce((s,[o,n])=>(n!=null&&n!==""&&!(Array.isArray(n)&&n.length===0)&&!(typeof n=="object"&&!Array.isArray(n)&&Object.keys(n).length===0&&n.constructor===Object)&&(s[o]=n),s),{}),e.normalizeArgs=t=>t instanceof Error?{title:t.name,message:t.message,stack:t.stack||null}:t==null?{message:String(t)}:Array.isArray(t)?{message:JSON.stringify(t)}:typeof t=="object"?t:{message:String(t)}}),ee=j(e=>{var{sanitizeObject:t,normalizeArgs:s}=q();e.useLogstyx=o=>{let{projectId:n,apiKey:a,appid:l,endpoint:r="https://api.logstyx.com/v1/logs",device:c,sendFunc:d,signatureFunc:R}=o;typeof d!="function"&&(d=fetch);let p={appid:l};function D(u){p=A(A({},p),u)}function U(u){if(Array.isArray(u))for(let w of u)delete p[w];else p={}}function f(u){return Z(this,arguments,function*(w,_={}){try{let g=t({level:w,projectId:n,appid:l,device:c,context:t(p),data:t(s(_))}),x={"Content-Type":"application/json"};if(typeof R=="function"){let{timestamp:$,signature:z}=R(n,a,g);x.signature=z,x.timestamp=$}return d(r,{method:"POST",body:JSON.stringify(g),headers:x})}catch(g){console.error(g)}})}return{info:u=>f("INFO",u),warning:u=>f("WARNING",u),error:u=>f("ERROR",u),critical:u=>f("CRITICAL",u),send:f,setContext:D,clearContext:U}}}),{useLogstyx:te}=ee();H.exports=e=>te(e)});var L=h((Re,N)=>{function se(e={}){let t=i({logstyx:e.logstyxInstance||console,redactFields:e.redactFields||["mobile","phone","email","password","token","authorization","creditCard"],buildRequestPayload:e.buildRequestPayload||ue,contextHook:e.contextHook||null,trackPerformance:e.trackPerformance!==!1,slowRequestThreshold:e.slowRequestThreshold||1e3,logLevels:e.logLevels||{success:"SUCCESS",error:"ERROR",critical:"CRITICAL",warning:"WARNING"}},e);return{successHandler:ne(t),notFoundHandler:ce(t),errorHandler:re(t),asyncHandler:s=>(o,n,a)=>{Promise.resolve(s(o,n,a)).catch(a)}}}function ne(e){return(t,s,o)=>{let n=["send","json","end"],a={},l=!1;n.forEach(r=>{a[r]=s[r],s[r]=(c=>function(...d){return!l&&me(s,t)&&(l=!0,oe(t,s,c,d,e)),!l&&ye(s,t,e)&&(l=!0,ae(t,s,c,d,e)),a[c].apply(this,d)})(r)}),e.trackPerformance&&(t._startTime=Date.now()),o()}}function oe(e,t,s,o,n){let a=n.trackPerformance?Date.now()-e._startTime:null,l=v(e,n),r=m(i({title:`${e.method} ${e.originalUrl}`,message:"Request completed successfully"},l),{body:y(e.body,n.redactFields),response:s==="json"||s==="send"?y(o[0],n.redactFields):null,responseTime:a,statusCode:t.statusCode,isSlow:a>n.slowRequestThreshold});n.logstyx.send(n.logLevels.success,r)}function ae(e,t,s,o,n){let a=n.trackPerformance?Date.now()-e._startTime:null,l=v(e,n),r=m(i({title:`${e.method} ${e.originalUrl}`,message:`Slow request detected (${a}ms)`},l),{body:y(e.body,n.redactFields),response:s==="json"||s==="send"?y(o[0],n.redactFields):null,responseTime:a,statusCode:t.statusCode,isSlow:a>n.slowRequestThreshold});n.logstyx.send(n.logLevels.warning,r)}function re(e){return(t,s,o,n)=>{let a=t.statusCode||t.status||500;o.status(a).json(i({code:a,message:t.message||"Internal Server Error"},process.env.NODE_ENV==="development"&&{stack:t.stack})),le(t,s,e),n(t)}}function le(e,t,s){var r;let o=s.trackPerformance?Date.now()-t._startTime:null,n=v(t,s),a=m(i({title:`${t.method} ${t.originalUrl}`,message:e==null?void 0:e.message},n),{stack:e==null?void 0:e.stack,errorType:(r=e==null?void 0:e.constructor)==null?void 0:r.name,code:e==null?void 0:e.code,body:y(t.body,s.redactFields),responseTime:o,statusCode:(e==null?void 0:e.statusCode)||(e==null?void 0:e.status)||500}),l=e.statusCode>=500?s.logLevels.critical:s.logLevels.error;s.logstyx.send(l,a)}function ce(e){return(t,s,o)=>{let n=new Error(`Route not found: ${t.method} ${t.originalUrl}`);n.statusCode=404,n.code="NOT_FOUND",o(n)}}function ue(e){return{method:e.method,url:e.url,path:e.path,ip:e.ip,userAgent:e.get("User-Agent"),requestId:e.id||e.headers["x-request-id"],user:ie(e),admin:de(e),session:e.session?{id:e.session.id}:null,query:e.query,params:e.params}}function ie(e){var o,n,a,l;return[e.user,(o=e.auth)==null?void 0:o.user,(n=e.session)==null?void 0:n.user,(a=e.locals)==null?void 0:a.user,(l=e.context)==null?void 0:l.user,e.currentUser,e.account,e.profile].find(r=>r&&(r.id||r.email||r.username))||null}function de(e){var t,s;return e.admin||((t=e.user)!=null&&t.isAdmin?e.user:null)||((s=e.session)==null?void 0:s.admin)}function me(e,t,s){let o=e.statusCode>=200&&e.statusCode<300;return!["POST","PUT","PATCH","DELETE"].includes(t.method)||s!=null&&s.trackPerformance&&t._startTime&&Date.now()-t._startTime>s.slowRequestThreshold?!1:o}function ye(e,t,s){if(!(s!=null&&s.trackPerformance)||!t._startTime)return!1;let n=Date.now()-t._startTime>s.slowRequestThreshold;return e.statusCode>=200&&e.statusCode<300&&n}function v(e,t){let s=t.buildRequestPayload(e);if(t.contextHook){let o=t.contextHook(e);s=i(i({},s),o)}return y(s,t.redactFields)}function y(e,t){if(!e||typeof e!="object")return e;e.toObject&&typeof e.toObject=="function"&&(e=e.toObject());let s=Array.isArray(e)?[]:{};for(let[o,n]of Object.entries(e))t.includes(o.toLowerCase())?s[o]="[REDACTED]":n!==null&&typeof n=="object"?s[o]=y(n,t):s[o]=n;return s}N.exports={createExpressMiddleware:se}});var F=require("os"),{generateSignature:pe}=P(),fe=I(),{createExpressMiddleware:ge}=L(),[he]=process.versions.node.split(".").map(Number);if(he<18)throw new Error("Logstyx SDK requires Node.js version 18 or higher. Please upgrade your Node.js runtime.");module.exports=e=>{let t;t={type:"express",origin:null,os:F.type(),platform:F.platform(),browser:null,screen:null};let s=fe(m(i({},e),{device:t,signatureFunc:pe}));if((e==null?void 0:e.captureUncaught)===!0)try{typeof process!="undefined"&&typeof window=="undefined"&&process.on("uncaughtException",n=>s.critical({title:(n==null?void 0:n.name)||"Unknown Error",message:n==null?void 0:n.message,stack:(n==null?void 0:n.stack)||null}))}catch(n){console.error(n)}if((e==null?void 0:e.captureUnhandledRejections)===!0)try{let n=a=>{let l=a instanceof Error?a.message:String(a),r=a instanceof Error?a.stack:void 0,c=a instanceof Error?a.name:"Unhandled Rejection";s.critical({title:c,message:l,stack:r})};process.on("unhandledRejection",n)}catch(n){console.error(n)}let o=ge(m(i({},e),{logstyxInstance:s,logLevels:{success:"SUCCESS",error:"ERROR",critical:"CRITICAL",warning:"WARNING"}}));return m(i({},s),{successHandler:o.successHandler,errorHandler:o.errorHandler,notFoundHandler:o.notFoundHandler,asyncHandler:o.asyncHandler})};
